#!/bin/bash

# Variáveis
USER_HOME="/home/$(whoami)"  # Diretório do usuário
JELLYFIN_DIR="$USER_HOME/jellyfin"
MOVIES_DIR="$JELLYFIN_DIR/movies"
SERIES_DIR="$JELLYFIN_DIR/series"
CONFIG_DIR="$JELLYFIN_DIR/config"
CACHE_DIR="$JELLYFIN_DIR/cache"

# Função para verificar a existência de um comando
command_exists() {
  command -v "$1" &>/dev/null
}

# Atualizar pacotes e instalar dependências
echo "Atualizando pacotes..."
sudo apt update -y
sudo apt upgrade -y
sudo apt dist-upgrade -y

# Instalar pacotes básicos
echo "Instalando dependências básicas..."
sudo apt install -y apt-transport-https ca-certificates curl software-properties-common git

# Instalar Docker, se não estiver instalado
if ! command_exists docker; then
  echo "Instalando Docker..."
  curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
  echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
  sudo apt update -y
  sudo apt install -y docker-ce docker-ce-cli containerd.io
else
  echo "Docker já está instalado."
fi

# Instalar Docker Compose, se não estiver instalado
if ! command_exists docker-compose; then
  echo "Instalando Docker Compose..."
  sudo apt install -y docker-compose
else
  echo "Docker Compose já está instalado."
fi

# Verificar versões do Docker e Docker Compose
echo "Verificando versões do Docker..."
docker --version
echo "Verificando versões do Docker Compose..."
docker-compose --version

# Clonar o repositório do Jellyfin
echo "Clonando o repositório Jellyfin..."
if [ ! -d "$JELLYFIN_DIR" ]; then
  git clone https://github.com/shazaltman/jellyfin-server.git "$JELLYFIN_DIR"
else
  echo "Repositório Jellyfin já existe em $JELLYFIN_DIR"
fi

# Criar diretórios para o Jellyfin
echo "Criando diretórios para o Jellyfin..."
mkdir -p "$CONFIG_DIR" "$CACHE_DIR" "$MOVIES_DIR" "$SERIES_DIR"

# Ajustar permissões dos diretórios
echo "Ajustando permissões dos diretórios..."
sudo chown -R $USER:$USER "$JELLYFIN_DIR"

# Criar o arquivo docker-compose.yml, se não existir
echo "Criando o arquivo docker-compose.yml..."
cat <<EOF > "$JELLYFIN_DIR/docker-compose.yml"
version: "3.8"
services:
  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    restart: unless-stopped
    ports:
      - "8096:8096"
    volumes:
      - "$JELLYFIN_DIR/config:/config"
      - "$JELLYFIN_DIR/cache:/cache"
      - "$JELLYFIN_DIR/movies:/media/movies"
      - "$JELLYFIN_DIR/series:/media/series"
    environment:
      - PUID=1000
      - PGID=1000
    network_mode: bridge
EOF

# Iniciar o Jellyfin com Docker Compose
echo "Iniciando o Jellyfin com Docker Compose..."
cd "$JELLYFIN_DIR"
sudo docker-compose up -d || { echo "Falha ao iniciar o Jellyfin"; exit 1; }

# Verificar se o container Jellyfin está em execução
echo "Verificando se o Jellyfin está em execução..."
sudo docker ps --filter "name=jellyfin"

# Conclusão
echo "Jellyfin instalado e em execução! Acesse a interface web em http://localhost:8096 para configurar o servidor."
