#!/bin/bash

# Variáveis
USER_HOME="/home/usuario"  # Substitua por seu diretório de usuário
JELLYFIN_DIR="$USER_HOME/jellyfin"
MOVIES_DIR="$JELLYFIN_DIR/movies"
SERIES_DIR="$JELLYFIN_DIR/series"
CONFIG_DIR="$JELLYFIN_DIR/config"
CACHE_DIR="$JELLYFIN_DIR/cache"

# Atualizar pacotes e instalar dependências
echo "Atualizando pacotes..."
sudo apt update -y
sudo apt install -y apt-transport-https ca-certificates curl software-properties-common

# Adicionar chave GPG do Docker
echo "Adicionando chave GPG do Docker..."
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg || { echo "Falha ao adicionar a chave GPG do Docker"; exit 1; }

# Adicionar repositório Docker
echo "Adicionando repositório Docker..."
UBUNTU_VERSION=$(lsb_release -cs) || { echo "Falha ao determinar a versão do Ubuntu"; exit 1; }
echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $UBUNTU_VERSION stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# Instalar Docker
echo "Instalando o Docker..."
sudo apt update -y
sudo apt install -y docker-ce
if ! dpkg -l | grep -q docker-ce; then
  echo "Erro ao instalar Docker"; exit 1;
fi

# Instalar Docker Compose
echo "Instalando Docker Compose..."
sudo apt install -y docker-compose
if ! dpkg -l | grep -q docker-compose; then
  echo "Erro ao instalar Docker Compose"; exit 1;
fi

# Verificar versões do Docker e Docker Compose
echo "Verificando versões do Docker..."
docker --version
echo "Verificando versões do Docker Compose..."
docker-compose --version

# Criar diretórios para o Jellyfin
echo "Criando diretórios para o Jellyfin..."
mkdir -p "$CONFIG_DIR" "$CACHE_DIR" "$MOVIES_DIR" "$SERIES_DIR"

# Ajustar permissões dos diretórios
sudo chown -R $USER:$USER "$JELLYFIN_DIR"

# Criar arquivo docker-compose.yml
echo "Criando o arquivo docker-compose.yml..."
cat <<EOF > "$JELLYFIN_DIR/docker-compose.yml"
version: "3.8"
services:
  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    restart: unless-stopped
    ports:
      - "8096:8096"
    volumes:
      - "$JELLYFIN_DIR/config:/config"
      - "$JELLYFIN_DIR/cache:/cache"
      - "$JELLYFIN_DIR/movies:/media/movies"
      - "$JELLYFIN_DIR/series:/media/series"
    environment:
      - PUID=1000
      - PGID=1000
    network_mode: bridge
EOF

# Iniciar o Jellyfin com Docker Compose
echo "Iniciando o Jellyfin com Docker Compose..."
cd "$JELLYFIN_DIR"
sudo docker-compose up -d || { echo "Falha ao iniciar o Jellyfin"; exit 1; }

# Verificar se o container Jellyfin está em execução
echo "Verificando se o Jellyfin está em execução..."
sudo docker ps --filter "name=jellyfin"

# Conclusão
echo "Jellyfin instalado e em execução! Acesse a interface web em http://localhost:8096 para configurar o servidor."
